{% extends 'base.html' %}
<!--
========================================
Psychic Spork - P√°gina do Dashboard
========================================
Esta √© a p√°gina inicial com vis√£o geral do sistema.
Mostra estat√≠sticas, cards de fabricantes e atividade.
========================================
-->

{% block content %}
<!-- Grid de cards de estat√≠sticas -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üîç</div>
        <div class="stat-info">
            <span class="stat-value" id="totalDiagnosticos">0</span>
            <span class="stat-label">Diagn√≥sticos</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-info">
            <span class="stat-value" id="taxaSucesso">0%</span>
            <span class="stat-label">Taxa de Sucesso</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">üìù</div>
        <div class="stat-info">
            <span class="stat-value" id="scriptsGerados">0</span>
            <span class="stat-label">Scripts Gerados</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">ü§ñ</div>
        <div class="stat-info">
            <span class="stat-value" id="consultasIA">0</span>
            <span class="stat-label">Consultas IA</span>
        </div>
    </div>
</div>

<!-- Se√ß√£o de Cards de Fabricantes -->
<section class="section">
    <h2 class="section-title">Fabricantes Suportados</h2>
    <div class="vendors-grid">
        {% for fab_id, fab in fabricantes.items() %}
        <div class="vendor-card {{ fab_id }}">
            <div class="vendor-icon">{{ fab.icone }}</div>
            <h3 class="vendor-name">{{ fab.nome }}</h3>
            <div class="vendor-versions">
                {% for ver_id, ver in fab.versoes.items() %}
                <span class="version-tag">{{ ver.nome }}</span>
                {% endfor %}
            </div>
            <a href="{{ url_for('main.troubleshoot') }}?fabricante={{ fab_id }}" class="vendor-link">
                Iniciar Troubleshoot ‚Üí
            </a>
        </div>
        {% endfor %}
    </div>
</section>

<!-- Se√ß√£o de Gr√°ficos -->
<section class="section">
    <h2 class="section-title">Estat√≠sticas de Uso</h2>
    <div class="charts-grid">
        <div class="chart-card">
            <h3>Diagn√≥sticos por Fabricante</h3>
            <canvas id="chartFabricantes"></canvas>
        </div>

        <div class="chart-card">
            <h3>Categorias de Problemas</h3>
            <canvas id="chartCategorias"></canvas>
        </div>
    </div>
</section>

<!-- A√ß√µes R√°pidas -->
<section class="section">
    <h2 class="section-title">A√ß√µes R√°pidas</h2>
    <div class="quick-actions">
        <a href="{{ url_for('main.troubleshoot') }}" class="action-btn primary">
            <span class="action-icon">üîß</span>
            <span class="action-text">Novo Diagn√≥stico</span>
        </a>

        <a href="{{ url_for('main.scripts') }}" class="action-btn secondary">
            <span class="action-icon">üìù</span>
            <span class="action-text">Gerar Script</span>
        </a>

        <a href="{{ url_for('main.chat') }}" class="action-btn tertiary">
            <span class="action-icon">ü§ñ</span>
            <span class="action-text">Perguntar √† IA</span>
        </a>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // Vari√°veis globais para gr√°ficos
    let chartFab = null;
    let chartCat = null;

    // Carrega estat√≠sticas ao iniciar a p√°gina
    document.addEventListener('DOMContentLoaded', function () {
        carregarEstatisticas();
    });

    // Busca estat√≠sticas da API e atualiza dashboard
    function carregarEstatisticas() {
        fetch('/api/estatisticas')
            .then(res => res.json())
            .then(data => {
                if (data.sucesso) {
                    const stats = data.estatisticas;

                    // Atualiza cards de estat√≠sticas
                    document.getElementById('totalDiagnosticos').textContent = stats.total || 0;
                    document.getElementById('taxaSucesso').textContent = (stats.taxa_sucesso || 0) + '%';
                    document.getElementById('scriptsGerados').textContent = stats.scripts_gerados || 0;
                    document.getElementById('consultasIA').textContent = stats.consultas_ia || 0;

                    // Inicializa gr√°ficos com dados reais
                    inicializarGraficos(stats);
                }
            })
            .catch(err => {
                console.log('Estat√≠sticas: aguardando servidor...', err);
                // Inicializa gr√°ficos vazios se API falhar
                inicializarGraficos({});
            });
    }

    // Inicializa gr√°ficos com dados reais
    function inicializarGraficos(stats) {
        // Dados de fabricantes
        const porFab = stats.por_fabricante || {};
        const fabLabels = Object.keys(porFab).length > 0
            ? Object.keys(porFab).map(f => f.charAt(0).toUpperCase() + f.slice(1))
            : ['Cisco', 'Nokia', 'FortiGate', 'Huawei'];
        const fabData = Object.keys(porFab).length > 0
            ? Object.values(porFab)
            : [0, 0, 0, 0];

        const fabColors = {
            'cisco': '#0066cc',
            'nokia': '#ff6600',
            'fortigate': '#ff3333',
            'huawei': '#00cc66',
            'generico': '#888888'
        };
        const fabBgColors = fabLabels.map(f => fabColors[f.toLowerCase()] || '#00d4ff');

        // Gr√°fico de fabricantes (pizza)
        const ctxFab = document.getElementById('chartFabricantes');
        if (ctxFab) {
            if (chartFab) chartFab.destroy();
            chartFab = new Chart(ctxFab, {
                type: 'doughnut',
                data: {
                    labels: fabLabels,
                    datasets: [{
                        data: fabData.length > 0 && fabData.some(v => v > 0) ? fabData : [1, 1, 1, 1],
                        backgroundColor: fabBgColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#e0e0e0' } }
                    }
                }
            });
        }

        // Dados de categorias
        const porCat = stats.por_categoria || {};
        const catLabels = Object.keys(porCat).length > 0
            ? Object.keys(porCat).map(c => c.charAt(0).toUpperCase() + c.slice(1))
            : ['Conectividade', 'Roteamento', 'Performance', 'Seguran√ßa'];
        const catData = Object.keys(porCat).length > 0
            ? Object.values(porCat)
            : [0, 0, 0, 0];

        // Gr√°fico de categorias (barras)
        const ctxCat = document.getElementById('chartCategorias');
        if (ctxCat) {
            if (chartCat) chartCat.destroy();
            chartCat = new Chart(ctxCat, {
                type: 'bar',
                data: {
                    labels: catLabels,
                    datasets: [{
                        label: 'Problemas',
                        data: catData,
                        backgroundColor: '#00d4ff',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#2a2a2a' }, ticks: { color: '#888' } },
                        x: { grid: { display: false }, ticks: { color: '#888' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    }

    // Atualiza estat√≠sticas a cada 30 segundos
    setInterval(carregarEstatisticas, 30000);
</script>
{% endblock %}
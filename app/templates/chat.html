{% extends 'base.html' %}
<!--
========================================
NetRouter AI - Chat com IA
========================================
P√°gina de chat para conversa livre com a IA.
========================================
-->

{% block content %}
<div class="chat-page-container">
    <div class="chat-main-card">
        <div class="chat-info">
            <h2>ü§ñ Assistente de Redes</h2>
            <p>Converse com a IA sobre configura√ß√£o de roteadores, troubleshooting,
                melhores pr√°ticas e d√∫vidas sobre Cisco, Nokia, FortiGate e Huawei.</p>
        </div>

        <!-- √Årea de Mensagens -->
        <div class="chat-messages-full" id="chatMessagesFull">
            <div class="message assistant">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <p>Ol√°! Sou o assistente especializado em redes. Posso ajudar com:</p>
                    <ul>
                        <li>Troubleshooting de problemas</li>
                        <li>Explica√ß√£o de comandos</li>
                        <li>Melhores pr√°ticas de configura√ß√£o</li>
                        <li>D√∫vidas sobre protocolos (BGP, OSPF, etc)</li>
                    </ul>
                    <p>Como posso ajudar hoje?</p>
                </div>
            </div>
        </div>

        <!-- Input de Mensagem -->
        <div class="chat-input-full">
            <textarea id="chatInputFull" rows="2" placeholder="Digite sua pergunta sobre redes..."
                onkeypress="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();enviarMensagemFull()}"></textarea>
            <button onclick="enviarMensagemFull()" class="btn btn-primary" id="btnEnviar">
                <span>Enviar</span>
            </button>
        </div>

        <button onclick="limparChat()" class="btn btn-small btn-secondary">
            üóëÔ∏è Limpar Conversa
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function enviarMensagemFull() {
        const input = document.getElementById('chatInputFull');
        const mensagem = input.value.trim();
        const btn = document.getElementById('btnEnviar');

        if (!mensagem) return;

        // Adiciona mensagem do usu√°rio
        adicionarMensagemFull('user', mensagem);
        input.value = '';
        btn.disabled = true;

        // Mostra indicador de digita√ß√£o
        adicionarMensagemFull('assistant', '<span class="typing">Pensando...</span>');

        // Chama a API
        fetch('/ai/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mensagem: mensagem })
        })
            .then(res => res.json())
            .then(data => {
                btn.disabled = false;
                // Remove indicador de digita√ß√£o
                const msgs = document.getElementById('chatMessagesFull');
                msgs.removeChild(msgs.lastChild);

                if (data.sucesso) {
                    adicionarMensagemFull('assistant', data.resposta);
                } else {
                    adicionarMensagemFull('assistant', '‚ùå Erro: ' + data.erro);
                }
            })
            .catch(err => {
                btn.disabled = false;
                const msgs = document.getElementById('chatMessagesFull');
                msgs.removeChild(msgs.lastChild);
                adicionarMensagemFull('assistant', '‚ùå Erro de conex√£o com o servidor.');
            });
    }

    function adicionarMensagemFull(role, conteudo) {
        const container = document.getElementById('chatMessagesFull');
        const div = document.createElement('div');
        div.className = 'message ' + role;

        const avatar = role === 'user' ? 'üë§' : 'ü§ñ';

        // Converte markdown b√°sico
        let html = conteudo
            .replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre>$2</pre>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/\n/g, '<br>');

        div.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">${html}</div>
    `;

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function limparChat() {
        if (!confirm('Limpar toda a conversa?')) return;

        fetch('/ai/limpar', { method: 'POST' })
            .then(() => {
                const container = document.getElementById('chatMessagesFull');
                container.innerHTML = `
                <div class="message assistant">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        <p>Conversa limpa! Como posso ajudar?</p>
                    </div>
                </div>
            `;
            });
    }
</script>
{% endblock %}